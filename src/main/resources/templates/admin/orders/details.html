<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>주문 상세 정보</title>
    <link rel="stylesheet" href="/admin/css/order-details.css">
</head>
<body>
<div th:fragment="content">
    <div class="card mb-4">
        <div class="card-header">
            <h5>주문 상세 정보</h5>
            <div class="header-controls">
                <a th:href="@{/admin/orders}" class="btn btn-light">목록으로</a>
            </div>
        </div>
        <div class="card-body">
            <!-- 주문 기본 정보 -->
            <div class="order-info-section">
                <div class="order-info-header">
                    <h6 class="order-number">
                        주문번호: <span th:text="${order.orderNumber}">20240512-001234</span>
                    </h6>
                    <div class="order-status">
                        <span th:class="${'status-badge ' + order.status.toLowerCase()}" th:text="${order.statusName}">
                            결제완료
                        </span>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">주문일시</span>
                        <span class="info-value" th:text="${#temporals.format(order.orderDate, 'yyyy-MM-dd HH:mm:ss')}">2024-05-12 14:30:00</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">고객명</span>
                        <span class="info-value" th:text="${order.customerName}">홍길동</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">연락처</span>
                        <span class="info-value" th:text="${order.phoneNumber}">010-1234-5678</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">이메일</span>
                        <span class="info-value" th:text="${order.email}">hong@example.com</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">결제방법</span>
                        <span class="info-value" th:text="${order.paymentMethod}">카드결제</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">총 결제금액</span>
                        <span class="info-value highlight" th:text="${#numbers.formatInteger(order.totalAmount, 0, 'COMMA') + '원'}">32,000원</span>
                    </div>
                </div>
            </div>

            <!-- 주문 상태 변경 폼 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">주문 상태 관리</h6>
                </div>
                <div class="card-body">
                    <form th:action="@{/admin/orders/status}" method="post" id="orderStatusForm">
                        <input type="hidden" name="orderId" th:value="${order.id}">
                        <div class="form-layout">
                            <div class="form-layout-item">
                                <label for="orderStatus" class="form-label">주문상태 변경</label>
                                <select id="orderStatus" name="orderStatus" class="form-control">
                                    <option value="PENDING" th:selected="${order.status == 'PENDING'}">결제대기</option>
                                    <option value="PAID" th:selected="${order.status == 'PAID'}">결제완료</option>
                                    <option value="PREPARING" th:selected="${order.status == 'PREPARING'}">상품준비중</option>
                                    <option value="SHIPPING" th:selected="${order.status == 'SHIPPING'}">배송중</option>
                                    <option value="DELIVERED" th:selected="${order.status == 'DELIVERED'}">배송완료</option>
                                    <option value="CANCELED" th:selected="${order.status == 'CANCELED'}">주문취소</option>
                                    <option value="REFUNDED" th:selected="${order.status == 'REFUNDED'}">환불완료</option>
                                </select>
                            </div>
                            <div class="form-layout-item" style="flex: 5;">
                                <label for="statusNote" class="form-label">상태변경 메모</label>
                                <input type="text" id="statusNote" name="statusNote" class="form-control" placeholder="상태 변경 사유나 메모를 입력하세요">
                            </div>
                            <div class="form-layout-item" style="flex: 1; min-width: 120px;">
                                <button type="submit" class="btn btn-primary">상태 변경</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 상태 변경 이력 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">상태 변경 이력</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                            <tr>
                                <th style="text-align: center;">변경일시</th>
                                <th style="text-align: center;">이전 상태</th>
                                <th style="text-align: center;">변경 상태</th>
                                <th style="text-align: center;">담당자</th>
                                <th style="text-align: left;">메모</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:if="${#lists.isEmpty(statusHistory)}">
                                <td colspan="5" style="text-align: center;">
                                    상태 변경 이력이 없습니다.
                                </td>
                            </tr>
                            <tr th:each="history : ${statusHistory}" th:if="${!#lists.isEmpty(statusHistory)}">
                                <td style="text-align: center;" th:text="${#temporals.format(history.changeDate, 'yyyy-MM-dd HH:mm')}">2024-05-12 15:30</td>
                                <td style="text-align: center;">
                                        <span th:class="${'status-badge small ' + history.prevStatus.toLowerCase()}" th:text="${history.prevStatusName}">
                                            결제완료
                                        </span>
                                </td>
                                <td style="text-align: center;">
                                        <span th:class="${'status-badge small ' + history.newStatus.toLowerCase()}" th:text="${history.newStatusName}">
                                            상품준비중
                                        </span>
                                </td>
                                <td style="text-align: center;" th:text="${history.adminName}">관리자</td>
                                <td style="text-align: left;" th:text="${history.note}">상품 준비 시작</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 배송 정보 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">배송 정보</h6>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">받는사람</span>
                            <span class="info-value" th:text="${order.recipientName}">홍길동</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">연락처</span>
                            <span class="info-value" th:text="${order.recipientPhone}">010-1234-5678</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">우편번호</span>
                            <span class="info-value" th:text="${order.zipCode}">12345</span>
                        </div>
                        <div class="info-item" style="grid-column: span 2;">
                            <span class="info-label">주소</span>
                            <span class="info-value" th:text="${order.address + ' ' + order.addressDetail}">서울시 강남구 역삼동 123-45 6층</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">배송 요청사항</span>
                            <span class="info-value" th:text="${order.deliveryRequest}">문 앞에 놓아주세요</span>
                        </div>
                    </div>

                    <!-- 배송 정보 입력/수정 폼 -->
                    <div class="form-layout" th:if="${order.status == 'PREPARING' || order.status == 'SHIPPING'}" style="margin-top: 1rem;">
                        <form th:action="@{/admin/orders/shipping}" method="post" id="shippingForm" class="form-layout" style="width: 100%;">
                            <input type="hidden" name="orderId" th:value="${order.id}">
                            <div class="form-layout-item" style="flex: 2;">
                                <label for="courierName" class="form-label">택배사</label>
                                <select id="courierName" name="courierName" class="form-control">
                                    <option value="">택배사 선택</option>
                                    <option value="CJ대한통운" th:selected="${order.courierName == 'CJ대한통운'}">CJ대한통운</option>
                                    <option value="롯데택배" th:selected="${order.courierName == '롯데택배'}">롯데택배</option>
                                    <option value="우체국택배" th:selected="${order.courierName == '우체국택배'}">우체국택배</option>
                                    <option value="한진택배" th:selected="${order.courierName == '한진택배'}">한진택배</option>
                                    <option value="로젠택배" th:selected="${order.courierName == '로젠택배'}">로젠택배</option>
                                    <option value="기타" th:selected="${order.courierName == '기타'}">기타</option>
                                </select>
                            </div>
                            <div class="form-layout-item" style="flex: 3;">
                                <label for="trackingNumber" class="form-label">송장번호</label>
                                <input type="text" id="trackingNumber" name="trackingNumber" th:value="${order.trackingNumber}" class="form-control" placeholder="송장번호를 입력하세요">
                            </div>
                            <div class="form-layout-item" style="flex: 1; min-width: 120px;">
                                <button type="submit" class="btn btn-primary">배송정보 저장</button>
                            </div>
                        </form>
                    </div>

                    <!-- 배송 추적 정보 -->
                    <div class="tracking-info-box" th:if="${order.trackingNumber != null && !order.trackingNumber.isEmpty()}">
                        <div>
                            <span style="font-weight: 600;">택배사: </span>
                            <span th:text="${order.courierName}">CJ대한통운</span>
                            &nbsp;&nbsp;|&nbsp;&nbsp;
                            <span style="font-weight: 600;">송장번호: </span>
                            <span th:text="${order.trackingNumber}">1234567890</span>
                        </div>
                        <a th:href="${'https://tracker.delivery/#/' + order.courierCode + '/' + order.trackingNumber}" target="_blank" class="btn btn-light">배송조회</a>
                    </div>
                </div>
            </div>

            <!-- 주문 상품 목록 -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">주문 상품 목록</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                            <tr>
                                <th style="text-align: center; width: 80px;">상품 이미지</th>
                                <th style="text-align: left;">상품정보</th>
                                <th style="text-align: center; width: 100px;">수량</th>
                                <th style="text-align: right; width: 150px;">판매가</th>
                                <th style="text-align: right; width: 150px;">주문금액</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item : ${orderItems}">
                                <td style="text-align: center;">
                                    <img th:src="${item.imageUrl}" alt="상품 이미지" class="product-image">
                                </td>
                                <td style="text-align: left;">
                                    <div style="margin-bottom: 0.25rem; font-weight: 600;" th:text="${item.productName}">유기농 사과 세트</div>
                                    <div style="font-size: 0.85rem; color: #858796;" th:text="${'상품번호: ' + item.productId}">상품번호: P12345</div>
                                    <div style="font-size: 0.85rem; color: #858796;" th:if="${item.optionName != null && !item.optionName.isEmpty()}" th:text="${'옵션: ' + item.optionName}">옵션: 소과 / 9개입</div>
                                </td>
                                <td style="text-align: center;" th:text="${item.quantity + '개'}">2개</td>
                                <td style="text-align: right;" th:text="${#numbers.formatInteger(item.price, 0, 'COMMA') + '원'}">16,000원</td>
                                <td style="text-align: right; font-weight: 600;" th:text="${#numbers.formatInteger(item.totalPrice, 0, 'COMMA') + '원'}">32,000원</td>
                            </tr>
                            </tbody>
                            <tfoot>
                            <tr style="background-color: #f8f9fc;">
                                <td colspan="4" style="text-align: right; font-weight: 600;">
                                    상품 금액 합계
                                </td>
                                <td style="text-align: right; font-weight: 600;" th:text="${#numbers.formatInteger(order.productTotalAmount, 0, 'COMMA') + '원'}">
                                    32,000원
                                </td>
                            </tr>
                            <tr>
                                <td colspan="4" style="text-align: right;">
                                    배송비
                                </td>
                                <td style="text-align: right;" th:text="${#numbers.formatInteger(order.shippingFee, 0, 'COMMA') + '원'}">
                                    3,000원
                                </td>
                            </tr>
                            <tr th:if="${order.discountAmount > 0}">
                                <td colspan="4" style="text-align: right;">
                                    할인금액
                                </td>
                                <td style="text-align: right; color: #e74a3b;" th:text="${'-' + #numbers.formatInteger(order.discountAmount, 0, 'COMMA') + '원'}">
                                    -3,000원
                                </td>
                            </tr>
                            <tr>
                                <td colspan="4" style="text-align: right; font-weight: 600; font-size: 1.1rem;">
                                    총 결제금액
                                </td>
                                <td style="text-align: right; font-weight: 600; font-size: 1.1rem; color: #4e73df;" th:text="${#numbers.formatInteger(order.totalAmount, 0, 'COMMA') + '원'}">
                                    32,000원
                                </td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 결제 정보 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">결제 정보</h6>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">결제 수단</span>
                            <span class="info-value" th:text="${order.paymentMethod}">카드결제</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">결제일시</span>
                            <span class="info-value" th:text="${#temporals.format(order.paidAt, 'yyyy-MM-dd HH:mm:ss')}" th:if="${order.paidAt != null}">2024-05-12 14:35:22</span>
                            <span class="info-value" th:if="${order.paidAt == null}">미결제</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">결제금액</span>
                            <span class="info-value highlight" th:text="${#numbers.formatInteger(order.totalAmount, 0, 'COMMA') + '원'}">32,000원</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">거래번호</span>
                            <span class="info-value" th:text="${order.paymentTransactionId}" th:if="${order.paymentTransactionId != null && !order.paymentTransactionId.isEmpty()}">TXID123456789</span>
                            <span class="info-value" th:if="${order.paymentTransactionId == null || order.paymentTransactionId.isEmpty()}">-</span>
                        </div>
                        <div class="info-item" th:if="${order.cardInfo != null && !order.cardInfo.isEmpty()}">
                            <span class="info-label">카드 정보</span>
                            <span class="info-value" th:text="${order.cardInfo}">신한카드 / 일시불</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 관리자 메모 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">관리자 메모</h6>
                </div>
                <div class="card-body">
                    <form th:action="@{/admin/orders/memo}" method="post" id="memoForm">
                        <input type="hidden" name="orderId" th:value="${order.id}">
                        <div class="form-group">
                            <textarea id="adminMemo" name="adminMemo" class="form-control" th:text="${order.adminMemo}"></textarea>
                        </div>
                        <div style="text-align: right;">
                            <button type="submit" class="btn btn-primary">메모 저장</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 버튼 그룹 -->
            <div class="button-group">
                <a th:href="@{/admin/orders}" class="btn btn-light">목록으로</a>
                <button type="button" class="btn btn-primary" onclick="window.print();">인쇄하기</button>

                <!-- 주문상태별 추가 액션 버튼 -->
                <div th:if="${order.status == 'PENDING'}">
                    <form th:action="@{/admin/orders/confirm-payment}" method="post" style="display: inline;">
                        <input type="hidden" name="orderId" th:value="${order.id}">
                        <button type="submit" class="btn btn-success" onclick="return confirm('결제 확인 처리하시겠습니까?');">결제 확인</button>
                    </form>
                </div>

                <div th:if="${order.status == 'PAID' || order.status == 'PREPARING'}">
                    <form th:action="@{/admin/orders/cancel}" method="post" style="display: inline;">
                        <input type="hidden" name="orderId" th:value="${order.id}">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('주문을 취소하시겠습니까? 결제 취소도 함께 진행됩니다.');">주문 취소</button>
                    </form>
                </div>

                <div th:if="${order.status == 'SHIPPING'}">
                    <form th:action="@{/admin/orders/complete-delivery}" method="post" style="display: inline;">
                        <input type="hidden" name="orderId" th:value="${order.id}">
                        <button type="submit" class="btn btn-success" onclick="return confirm('배송완료 처리하시겠습니까?');">배송완료 처리</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>