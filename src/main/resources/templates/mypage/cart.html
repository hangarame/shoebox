<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>장바구니</title>
<link rel="stylesheet" th:href="@{/member/css/shoebox.css}">
<style>
	.modal {
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: rgba(0, 0, 0, 0.5);
		z-index: 1000;
	}

	.modal-content {
		position: relative;
		background-color: white;
		width: 500px;
		margin: 100px auto;
		padding: 30px;
		border-radius: 8px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	}

	.modal-content h2 {
		margin: 0 0 20px 0;
		font-size: 1.5em;
		color: #333;
	}

	.coupon-item {
		padding: 15px;
		border: 1px solid #eee;
		margin: 10px 0;
		border-radius: 4px;
		cursor: pointer;
		display: flex;
		align-items: center;
		gap: 10px;
		transition: all 0.2s ease;
	}

	.coupon-item:hover {
		background-color: #f8f8f8;
		border-color: #ddd;
	}

	.coupon-item.selected {
		background-color: #e8f4ff;
		border-color: #0078ff;
	}


	.coupon-item span {
		font-size: 0.95em;
		color: #333;
	}


	.modal-footer button {
		padding: 8px 16px;
		margin-left: 10px;
	}

	#closeCouponModal, #applyCouponBtn {
		padding: 8px 20px;
		background-color: #333;
		color: white;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-size: 0.95em;
		transition: background-color 0.2s;
		font-weight: bold;
		align-content: center;
	}

	#closeCouponModal:hover, #applyCouponBtn:hover  {
		background-color: #555;
	}

	.coupon-item.disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}

	.coupon-item.disabled:hover {
		background-color: #f8f8f8;
	}

	.unavailable {
		color: #ff0000;
		font-size: 0.9em;
		margin-left: 10px;
	}

	.point-usage-section {
		padding: 20px;
		border-top: 1px solid #eee;
		display: flex;
		align-items: center;
		justify-content: space-between;
	}

	.point-usage-title {
		font-size: 1.1em;
		font-weight: 500;
		color: #333;
	}

	.point-usage-inputs {
		display: flex;
		align-items: center;
		gap: 10px;
	}

	.point-usage-inputs label {
		font-size: 0.95em;
		color: #666;
	}

	.point-usage-inputs input[type="number"] {
		width: 100px;
		height: 30px;
		border: 1px solid #ddd;
		border-radius: 4px;
		padding: 0 10px;
		text-align: right;
	}

	.point-usage-inputs input[type="checkbox"] {
		margin: 0 5px;
	}

</style>
</head>
<body>
	<th:block th:replace="~{inc/header.html :: header}"></th:block>

	<div class="cart-wrap">
		<!-- 진행 단계 표시 -->
		<div class="cart-location">
			<span class="active">01 장바구니</span>
			<span class="divider"> > </span>
			<span>02 주문서작성/결제</span>
			<span class="divider"> > </span>
			<span>03 주문완료</span>
		</div>

		<!-- 타이틀 -->
		<div class="cart-title">장바구니</div>


		<!-- 장바구니 테이블 -->
		<div class="cart-table-wrap">
			<table class="cart-table">
				<colgroup>
					<col style="width: 44px;">
					<col style="width: 90px;">
					<col style="width: auto;">
					<col style="width: 110px;">
					<col style="width: 90px;">
					<col style="width: 110px;">
					<col style="width: 120px;">
				</colgroup>
				<thead>
					<tr>
						<th><input type="checkbox" id="cart-check-all" class="cart-chk" checked></th>
						<th>상품정보</th>
						<th>상품명</th>
						<th>수량</th>
						<th>적립</th>
						<th>상품금액</th>
						<th>비고</th>
					</tr>
				</thead>
				<tbody>
				<!-- 카트 제품 불러오기 -->
				<tr class="cart-item" th:each="item : ${cartItems}">
					<!--카트 제품 이미지-->
					<td><input type="checkbox" class="cart-chk cart-chk-item" checked></td>
					<td>
						<!-- 이미지가 있는 경우 -->
						<img class="cart-img"
							 th:if="${not #lists.isEmpty(item.productStock.product.productImages)}"
							 th:src="@{'/common/images/' + ${item.productStock.product.productImages[0].fileName}}"
							 alt="product-image">
						<!-- 이미지가 없는 경우 -->
						<img class="cart-img"
							 th:unless="${not #lists.isEmpty(item.productStock.product.productImages)}"
							 src="/common/images/default.png"
							 alt="default-image">
					</td>
					<!-- 제품 정보 -->
					<td class="cart-prod-info">
						<div class="cart-prod-name" th:text="${item.productStock.product.productName}"></div>
						<div class="cart-prod-desc" th:text="${item.productStock.shoeSize}"></div>
						<div class="cart-prod-discount" th:data-cart-prod-discount="${item.productStock.product.discountRate}" hidden="hidden"></div>
					</td>
					<!-- 제품 수량 -->
					<td>
						<div class="cart-qty-wrap">
							<button class="cart-qty-btn minus">-</button>
							<input type="number" class="cart-qty-input quantity-input" th:value="${item.quantity}" min="1" max="99">
							<button class="cart-qty-btn plus">+</button>
						</div>
					</td>
					<!-- 상품 당 적립 포인트 -->
					<td class="cart-point">0P</td>
					<td>
						<div class="cart-price item-price" th:text="${#numbers.formatInteger(item.quantity * item.productStock.product.productPrice, 3, 'COMMA') + '원'}"
         th:data-price="${item.quantity * item.productStock.product.productPrice}"></div>
    <button class="cart-coupon-btn"
            th:data-product-discount-rate="${item.productStock.product.discountRate}"
            data-coupon-discount-rate="0"
            data-coupon-id="">쿠폰적용</button>
					</td>
					<td>
						<!-- 해당 유저의 cartItem 불러오기 -->
						<div class="cart-row-actions">
							<button class="cart-delete-btn" th:data-cart-item-id="${item.cartItemId}">
								<img src="/member/images/delete.png" class="delete-icon" style="width: 18px; position: relative; top: 2px;">
								삭제
							</button>
						</div>
					</td>
				</tr>
				</tbody>
				<tfoot>
					<tr>
						<td colspan="7">
							<div class="point-usage-section">
								<div class="point-usage-info">
									<div class="point-usage-title">보유 적립금 사용</div>
								</div>
								<div class="point-usage-inputs">
									<label for="use-allpoint-check">모든 포인트 사용</label>
									<input type="checkbox" id="use-allpoint-check">
									<label for="use-point">사용 포인트</label>
									<input type="number" id="use-point" value="0">
									<label for="use-point">point</label>
								</div>
							</div>
						</td>
					</tr>
				</tfoot>
			</table>
		</div>

		<!-- 상단 선택삭제/배송변경/품절삭제 버튼 -->
		<div class="cart-top-actions">
			<button class="cart-top-btn">선택삭제</button>
			<button class="cart-top-btn red">품절/판매종료 삭제</button>
		</div>

		<!-- 금액 요약 -->
		<div class="cart-summary-wrap">
			<div class="cart-summary-row">
				<div class="cart-summary-item">
					<span class="cart-summary-label">주문금액</span>
					<span class="cart-summary-value" id="totalAmount">0원</span>
				</div>
				<img src="/member/images/substract.png" class="cart-summary-icon"
					alt="substract">
				<div class="cart-summary-item">
					<span class="cart-summary-label">총 할인금액</span>
					<span class="cart-summary-value" id="totalDiscountAmount">0원</span>
				</div>
				<img src="/member/images/equal.png" class="cart-summary-icon" alt="equal">
				<div class="cart-summary-item total">
					<span class="cart-summary-label">결제예정금액</span>
					<span class="cart-summary-value" id="finalAmount">0원</span>
				</div>
			</div>
			<div class="cart-summary-detail-row">
				<div class="cart-summary-detail-col">
					<span class="cart-summary-detail-label">상품금액</span>
					<span class="cart-summary-detail-value" id="productAmount">0원</span>
				</div>
				<div class="cart-summary-detail-col">
					<span class="cart-summary-detail-label">추가 배송비</span>
					<span class="cart-summary-detail-value">0원</span>
				</div>
				<div class="cart-summary-detail-col">
					<span class="cart-summary-detail-label">총 할인금액</span>
					<span class="cart-summary-detail-value" id="detailDiscountAmount">0원</span>
				</div>
				<div class="cart-summary-detail-col">
					<span class="cart-summary-detail-label">예상 적립금</span>
					<span class="cart-summary-detail-value" id="pointAmount">0P</span>
				</div>
				<div class="cart-summary-detail-col">
					<span class="cart-summary-detail-label">결제예정금액</span>
					<span class="cart-summary-detail-value" id="detailFinalAmount" style="color: #ba0a0a;">0원</span>
				</div>
			</div>
		</div>

		<!-- 주문/쇼핑 계속 버튼 -->
		<div class="cart-action-row">
			<button class="cart-action-btn" onclick="goToOrder()">주문하기</button>
			<button class="cart-action-btn_secondary" onclick="window.location.href='/main/'">계속 쇼핑하기</button>
		</div>

		<!-- 안내문구 -->
		<div class="cart-info-box">
			<img src="/member/images/exclamation.png"
				style="width: 17px; margin-right: 5px; position: relative; top: 3px;">
			<b style="color: black;">상품 주문 전 꼭 확인해주세요!</b>
			<br>
			- A/S는 제품 ABC
			A/S센터 및 제조사별 A/S센터에서 가능합니다.<br>
			- 상품 주문 후 7일 이내에 교환/반품이 가능합니다.<br>
			- 상품에 따라 배송비가 추가될 수 있습니다.<br>
			- 기타 자세한 내용은 고객센터를 참고해 주세요.<br>
			- 일부 상품은 주문 후 품절될 수 있습니다.<br>
			- 결제완료 후 주문내역은 마이페이지에서 확인 가능합니다.<br>
			- 주문 전 상품정보와 배송정보를 반드시 확인하세요.<br>
		</div>
	</div>

	<!-- 쿠폰 모달 -->
	<div id="couponModal" class="modal" style="display: none;">
		<div class="modal-content">
			<h2>사용 가능한 쿠폰</h2>
			<div id="couponList"></div>
			<button id="applyCouponBtn">적용</button>
			<button id="closeCouponModal">닫기</button>
		</div>
	</div>



	<th:block th:replace="~{inc/footer.html :: footer}"></th:block>
</body>
<script>

	// 계산 업데이트
	function updateTotalAmount() {
		let totalAmount = 0;
		let totalDiscountAmount = 0;
		let totalOriginalAmount = 0;

		document.querySelectorAll('.cart-item').forEach(function(item) {
			if (item.querySelector('.cart-chk-item').checked) {
				const quantity = parseInt(item.querySelector('.cart-qty-input').value);
				const priceText = item.querySelector('.cart-price').textContent;
				const price = parseInt(priceText.replace(/,/g, '').replace('원', ''));

				const couponDiscountRateTemp = item.querySelector('.cart-coupon-btn');
				const discountRate = item.querySelector('.cart-prod-discount');
				const productDiscountRate = parseFloat(discountRate.getAttribute('data-cart-prod-discount') || 0);

				// 상품 원가 계산
				const itemOriginalAmount = quantity * price;
				totalOriginalAmount += itemOriginalAmount;

				// 상품 할인 계산
				let productDiscountAmount = 0;
				if (productDiscountRate > 0) {
					productDiscountAmount = Math.round(itemOriginalAmount * productDiscountRate / 100);
				}

				// 쿠폰 할인 계산
				const appliedCoupons = JSON.parse(couponDiscountRateTemp.getAttribute('data-applied-coupons') || '[]');
				let couponDiscountAmount = 0;

				// 각 수량별로 다른 쿠폰 적용
				for (let i = 0; i < quantity; i++) {
					if (i < appliedCoupons.length) {
						// 각 수량별로 개별 가격에 쿠폰 할인 적용
						const singleItemPrice = price;
						const couponDiscount = Math.round(singleItemPrice * (parseFloat(appliedCoupons[i].discountRate) / 100));
						couponDiscountAmount += couponDiscount;
					}
				}

				// 총 할인 금액 계산
				const itemTotalDiscount = productDiscountAmount + couponDiscountAmount;
				totalDiscountAmount += itemTotalDiscount;

				// 상품 총액 계산 (할인 적용)
				const itemTotalAmount = itemOriginalAmount - itemTotalDiscount;
				totalAmount += itemTotalAmount;
			}
		});

		// 계산된 합계를 화면에 표시
		document.getElementById('totalAmount').textContent = totalOriginalAmount.toLocaleString() + '원';
		document.getElementById('totalDiscountAmount').textContent = totalDiscountAmount.toLocaleString() + '원';
		document.getElementById('finalAmount').textContent = totalAmount.toLocaleString() + '원';

		// 상세 금액 정보 업데이트
		document.getElementById('productAmount').textContent = totalOriginalAmount.toLocaleString() + '원';
		document.getElementById('detailDiscountAmount').textContent = totalDiscountAmount.toLocaleString() + '원';
		document.getElementById('detailFinalAmount').textContent = totalAmount.toLocaleString() + '원';
	}

	// 현재 선택된 상품의 쿠폰 버튼을 저장할 변수
	let currentCouponButton = null;

	document.addEventListener('DOMContentLoaded', function () {
		// 체크박스 관련 코드
		const checkAll = document.getElementById('cart-check-all');
		const items = document.querySelectorAll('.cart-chk-item');

		// 상단 체크박스 클릭 시 하위 모두 체크/해제
		checkAll.addEventListener('change', function () {
			items.forEach(function (chk) {
				chk.checked = checkAll.checked;
			});
			updateTotalAmount();
		});

		// 하위 체크박스 상태에 따라 상단 체크박스도 자동 변경
		items.forEach(function (chk) {
			chk.addEventListener('change', function () {
				checkAll.checked = Array.from(items).every(function (item) {
					return item.checked;
				});
				updateTotalAmount();
			});
		});

		// 수량 조절 버튼 이벤트
		document.querySelectorAll('.cart-qty-wrap').forEach(function(wrap) {
			const minusBtn = wrap.querySelector('.cart-qty-btn.minus');
			const plusBtn = wrap.querySelector('.cart-qty-btn.plus');
			const input = wrap.querySelector('.cart-qty-input');

			minusBtn.addEventListener('click', function() {
				let value = parseInt(input.value, 10);
				if (value > parseInt(input.min, 10)) {
					input.value = value - 1;
					updateTotalAmount();
				}
			});

			plusBtn.addEventListener('click', function() {
				let value = parseInt(input.value, 10);
				if (input.max === "" || value < parseInt(input.max, 10)) {
					input.value = value + 1;
					updateTotalAmount();
				}
			});

			input.addEventListener('change', updateTotalAmount);
		});

		// 쿠폰 적용 버튼 이벤트
		document.getElementById('applyCouponBtn').addEventListener('click', function() {
			console.log('적용 버튼 클릭됨');
			const selectedCoupons = document.querySelectorAll('.coupon-item input[type="checkbox"]:checked');
			

				// 현재 상품의 수량 확인
				const cartItem = currentCouponButton.closest('.cart-item');
				const quantity = parseInt(cartItem.querySelector('.cart-qty-input').value);

				// 선택된 쿠폰들의 정보를 배열로 저장
				const appliedCoupons = Array.from(selectedCoupons).map(coupon => {
					const couponItem = coupon.closest('.coupon-item');
					return {
						discountRate: couponItem.getAttribute('data-discount-rate'),
						couponId: couponItem.getAttribute('data-coupon-id')
					};
				});

				// 수량에 맞게 쿠폰 분배
				const distributedCoupons = [];
				for (let i = 0; i < quantity; i++) {
					if (i < appliedCoupons.length) {
						distributedCoupons.push(appliedCoupons[i]);
					}
				}

				// 현재 선택된 쿠폰 버튼에 쿠폰 정보 배열 저장
				currentCouponButton.setAttribute('data-applied-coupons', JSON.stringify(distributedCoupons));
				// 첫 번째 쿠폰 ID를 data-coupon-id로도 저장 (기존 로직 호환성 유지)
				if (distributedCoupons.length > 0) {
					currentCouponButton.setAttribute('data-coupon-id', distributedCoupons[0].couponId);
				}
				
				// 금액 재계산
				updateTotalAmount();
				
				// 모달 닫기
				closeModal();
				
				// 현재 선택된 쿠폰 버튼 초기화
				currentCouponButton = null;
				


			closeModal();
			
		});

		// 쿠폰 버튼 클릭 이벤트
		document.querySelectorAll('.cart-coupon-btn').forEach(btn => {
			btn.addEventListener('click', function(e) {
				e.preventDefault();
				console.log('쿠폰 버튼 클릭됨');

				// 현재 클릭된 쿠폰 버튼 저장
				currentCouponButton = this;

				// 해당 상품의 정보
				const cartItem = this.closest('.cart-item');
				const priceElement = cartItem.querySelector('.cart-price');
				const itemPrice = parseInt(priceElement.getAttribute('data-price') || priceElement.textContent.replace(/[^0-9]/g, ''));

				console.log('상품 가격:', itemPrice);

				// 쿠폰 목록 출력
				fetch('/mypage/api/coupons')
					.then(response => {
						if (!response.ok) {
							if (response.status === 401) {
								throw new Error('로그인이 필요합니다.');
							}
							throw new Error('쿠폰 정보를 불러오는데 실패했습니다.');
						}
						return response.json();
					})
					.then(coupons => {
						console.log('API 응답 전체 데이터:', coupons);
						const couponList = document.getElementById('couponList');
						if (!couponList) {
							console.error('couponList element not found');
							return;
						}

						if (coupons.length === 0) {
							couponList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">사용 가능한 쿠폰이 없습니다.</div>';
						} else {
							// 쿠폰 필터링
							const availableCoupons = coupons.filter(coupon => {
								// 현재 상품에 적용된 쿠폰인지 확인
								const currentItemAppliedCoupons = JSON.parse(currentCouponButton.getAttribute('data-applied-coupons') || '[]');
								const isCurrentItemApplied = currentItemAppliedCoupons.some(applied => 
									applied.couponId === coupon.issuedCouponId.toString()
								);
								
								// 다른 상품들에 적용된 쿠폰 ID 목록
								const otherItemsAppliedCoupons = Array.from(document.querySelectorAll('.cart-coupon-btn[data-applied-coupons]'))
									.filter(btn => btn !== currentCouponButton)
									.map(btn => JSON.parse(btn.getAttribute('data-applied-coupons') || '[]'))
									.flat()
									.map(coupon => coupon.couponId);

								// 현재 상품에 적용된 쿠폰이면 포함
								if (isCurrentItemApplied) {
									return true;
								}
								
								// 다른 상품에 적용된 쿠폰이면 제외
								if (otherItemsAppliedCoupons.includes(coupon.issuedCouponId.toString())) {
									return false;
								}
								
								// 그 외의 쿠폰은 포함
								return true;
							});

							console.log('사용 가능한 쿠폰:', availableCoupons);

							couponList.innerHTML = availableCoupons.map(coupon => {
								// 현재 상품에 적용된 쿠폰인지 확인
								const appliedCoupons = JSON.parse(currentCouponButton.getAttribute('data-applied-coupons') || '[]');
								const isApplied = appliedCoupons.some(applied => 
									applied.couponId === coupon.issuedCouponId.toString()
								);
								
								// 체크박스로 출력
								return `
									<label class="coupon-label">
									<div class="coupon-item" 
										 data-coupon-id="${coupon.issuedCouponId}" 
										 data-discount-rate="${coupon.coupon.discountRate}">

										<input type="checkbox" name="coupon" value="${coupon.issuedCouponId}"
											   ${isApplied ? 'checked' : ''}>
										<span>${coupon.coupon.couponName}</span>
										<span>${coupon.coupon.discountRate}% 할인</span>
										<span>~${new Date(coupon.expireDatetime).toLocaleDateString()} 까지</span>
									</div>
									</label>
								`;
							}).join('');

							// 이미 적용된 쿠폰이 있다면 해당 쿠폰 selected 처리
							const appliedCoupons = JSON.parse(currentCouponButton.getAttribute('data-applied-coupons') || '[]');
							appliedCoupons.forEach(applied => {
								const appliedCouponItem = document.querySelector(`.coupon-item[data-coupon-id="${applied.couponId}"]`);
								if (appliedCouponItem) {
									appliedCouponItem.classList.add('selected');
									const checkbox = appliedCouponItem.querySelector('input[type="checkbox"]');
									if (checkbox) {
										checkbox.checked = true;
									}
								}
							});
						}

						// 모달 표시
						const modal = document.getElementById('couponModal');
						if (modal) {
							modal.style.display = 'block';
						}
					})
					.catch(error => {
						console.error('쿠폰 데이터를 가져오는 중 오류 발생:', error);
						alert(error.message || '쿠폰 정보를 불러오는데 실패했습니다.');
					});
			});
		});

		// 모달 닫기 버튼 이벤트
		document.getElementById('closeCouponModal').addEventListener('click', closeModal);

		// 모달 외부 클릭 시 닫기
		window.addEventListener('click', function(event) {
			const modal = document.getElementById('couponModal');
			if (event.target === modal) {
				closeModal();
			}
		});

		// 초기 금액 계산
		updateTotalAmount();
	});

	// 모달 닫기 함수
	function closeModal() {
		const modal = document.getElementById('couponModal');
		if (modal) {
			modal.style.display = 'none';
		}
	}

	function goToOrder() {
    // 선택된 상품의 ID 수집
    const selectedItems = Array.from(document.querySelectorAll('.cart-chk-item:checked'))
        .map(checkbox => {
            const cartItem = checkbox.closest('.cart-item');
            return cartItem.querySelector('.cart-delete-btn').getAttribute('data-cart-item-id');
        });

    if (selectedItems.length === 0) {
        alert('주문할 상품을 선택해주세요.');
        return;
    }

    // 선택된 상품 ID들을 쿼리 파라미터로 전달
    let queryString = selectedItems.map(id => `cartItemIds=${id}`).join('&');
    
    // 포인트 사용 정보 (포인트 사용 인터페이스가 있는 경우)
    const usePointInput = document.getElementById('use-point');
    const useAllPointCheck = document.getElementById('use-allpoint-check');
    
    if (usePointInput) {
        const pointValue = parseInt(usePointInput.value) || 0;
        queryString += `&usePoint=${pointValue}`;
    }
    
    if (useAllPointCheck) {
        queryString += `&useAllPoint=${useAllPointCheck.checked}`;
    }

    window.location.href = `/payment/orderlist?${queryString}`;
}
</script>

</html>